@model app.Models.Tool

@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Details";
}

<h2>Detaljer</h2>

<div id="app" v-cloak>
    <h4 style="display: inline-block;">@Model.Name</h4>
    <span class="glyphicon" aria-hidden="true"
          v-on:click="toggleFavorite"
          v-bind:class="{ 'glyphicon-star': favorite, 'glyphicon-star-empty' : !favorite}">
    </span>
    <hr />
    @if (Model.Image != "")
    {
        <img src="~/@Model.Image" style="">
    }
    else
    {
        <span class="glyphicon glyphicon-wrench" style="font-size: 100px;" aria-hidden="true"></span>
    }
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.Status)
        </dt>
        <dd>
            <i style="@Model.Status.Style" class="@Model.Status.Glyphicon"></i> @Html.DisplayFor(model => model.Status.StatusName)
        </dd>
        <dt>
            @Html.DisplayNameFor(model => model.Reports)
        </dt>
        @if (!Model.Reports.Any())
        {
            <dd></dd>
        }
        else
        {
           @foreach (var report in Model.Reports)
            {
                <dd>
                    - @report.Error
                    @if (@report.UserId == @UserManager.GetUserId(User) || User.IsInRole("Admin"))
                    {
                        <a asp-controller="Reports" asp-action="Edit" asp-route-id="@report.Id">Edit</a> @Html.Raw("|")
                        <a asp-controller="Reports" asp-action="Details" asp-route-id="@report.Id">Details</a> @Html.Raw("|")
                        <a asp-controller="Reports" asp-action="Delete" asp-route-id="@report.Id">Delete</a> 
                    }
                </dd>
            }
        }
        <dt>
            @Html.DisplayNameFor(model => model.Alarms)
        </dt>
        @if (!Model.Alarms.Any())
        {
            <dd></dd>
        }
        else
        {
            @foreach (var alarm in Model.Alarms)
            {
                <dd>
                    - @alarm.Name: @alarm.Date
                    @if (User.IsInRole("Admin"))
                    {
                        <a asp-controller="Alarms" asp-action="Edit" asp-route-id="@alarm.Id">Edit</a> @Html.Raw("|")
                        <a asp-controller="Alarms" asp-action="Details" asp-route-id="@alarm.Id">Details</a> @Html.Raw("|")
                        <a asp-controller="Alarms" asp-action="Delete" asp-route-id="@alarm.Id">Delete</a>
                    }
                </dd>
            }
        }
    </dl>

    <div class="buttons">
        <!-- Button to trigger reservation dialog to popup -->
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#reservationDialog">
            Reservér
        </button>
        <button type="button" class="btn btn-success" v-on:click="checkIn(@Model.Id)" v-if="checkedOut">
            Sjekk inn
        </button>
        <button type="button" class="btn btn-danger" v-on:click="checkOut(@Model.Id)" v-else>
            Sjekk ut
        </button>
        <a href="/Reports/Create/@Model.Id" class="btn btn-warning">Rapporter feil</a>

        @if (User.IsInRole("Admin"))
        {
            <a href="/Alarms/Create/@Model.Id" class="btn btn-info">Registrer alarm</a>
        }
    </div>

    <br>
    <a asp-action="Index">Tilbake til verktøyliste</a>

    <h3>Reservasjoner</h3>
    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th>Reservert av</th>
                <th>Start</th>
                <th>Slutt</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="r in reservations">
                <td>{{ r.user.userName }}</td>
                <td>{{ r.fromDate }}</td>
                <td>{{ r.toDate }}</td>
                <td>
                    <button v-if="r.userId == '@UserManager.GetUserId(User)'" v-on:click="deleteReservation(r.id)" class="close" style="color: red;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Reservation dialog -->
    @await Html.PartialAsync("ReserveDialogPartial", new app.Models.Reservation())
    
    <!-- Confirmation dialog -->
    @await Html.PartialAsync("ConfirmDialogPartial")
</div>

<style>
    .buttons .btn {
        margin-top: 5px;
    }
</style>

@section Scripts {
<!-- Script for custom confirmation dialog -->
<script src="~/js/confirm-dialog.js"></script>

<script>
var app = new Vue({
    el: '#app',
    data: {
        faviconhover: false,
        favorite: false,
        checkedOut: false,
        reservations: [],
        reservationForm: {
            FromDate: '',
            ToDate: ''
        }
    },
    created: function () {
        this.loadReservations();

        var self = this;
        axios.get('/api/favorites')
        .then(function (response) {
            for (var i = 0; i < response.data.length; i++) {
                if (response.data[i].toolId == @Model.Id) {
                    self.favorite = true;
                    return;
                }
            }
        }); 

        axios.get('/api/Tools/' + @Model.Id)
        .then(function (response) {
            self.checkedOut = response.data.checkedOut;
        }); 
    },
    methods: {
        loadReservations: function() {
            var self = this;

            // Fetch list of users
            axios.get('/api/reservations/?toolid=@Model.Id')
            .then(function (response) {
                self.reservations = response.data;
            }); 
        },
        saveReservation: function() {
            var self = this;

            var data = {
                ToolId: @Model.Id,
                FromDate: this.reservationForm.FromDate,
                ToDate: this.reservationForm.ToDate
            };

            axios.post('/api/reservations', JSON.stringify(data), { headers: { 'content-type': 'application/json; charset=utf-8' } })
            .then(function (response) {
                if (response.status == 201)
                    $('#reservationDialog').modal('hide');

                // TODO: Error reporting

                // Reload reservations
                self.loadReservations();
            });
        },
        cancelReservation: function() {
            $('#reservationDialog').modal('hide');
            this.reservationForm.FromDate = '';
            this.reservationForm.ToDate = '';
        },
        deleteReservation: function(id) {
            var self = this;

            var options = {
                title: 'Slett reservasjon',
                message: 'Er du sikker på at du vil slette reservasjonen?'
            }

            ConfirmDialog(options, function(){
                axios.delete('/api/reservations/' + id)
                .then(function(response) {
                    if (response.status == 200) {
                        for (var i = 0; i < self.reservations.length; i++) {
                            if (self.reservations[i].id == id) {
                                self.reservations.splice(i, 1);
                                return;
                            }
                        }
                    }
                });
            })
        },
        toggleFavorite: function() {
            var self = this;

            if (!this.favorite) {
                axios.post('/api/Favorites', JSON.stringify({ toolid: @Model.Id }), { headers: { 'Content-Type': 'application/json' }})
                .then(function (response) {
                    if (response.status == 201)
                        self.favorite = true;
                });
            }
            else {
                axios.delete('/api/Favorites', { data: JSON.stringify({ toolid: @Model.Id }), headers: { 'Content-Type': 'application/json' }})
                .then(function (response) {
                    if (response.status == 200)
                        self.favorite = false;
                });
            }
        },
        checkOut: function(id) {
            var self = this;

            var currentDate = new Date();

            var stopLoop = false;

            if (self.reservations.length == 0) {
                axios.put('/api/Tools/' + id, {
                        id: id,
                        name: '@Model.Name',
                        status: '@Model.Status',
                        checkedOut: true
                    })

                    self.checkedOut = true;
            }
            else {
                self.reservations.forEach(function(reservation) {

                if (stopLoop)
                    return;

                if (reservation.userId == '@UserManager.GetUserId(User)'
                && reservation != self.reservations[self.reservations.length - 1])
                    return;

                if (reservation.userId == '@UserManager.GetUserId(User)'
                && reservation == self.reservations[self.reservations.length - 1])
                {
                    axios.put('/api/Tools/' + id, {
                        id: id,
                        name: '@Model.Name',
                        status: '@Model.Status',
                        checkedOut: true
                    })

                    self.checkedOut = true;

                    return;
                }

                var toDate = new Date(reservation.toDate);    
                var fromDate = new Date(reservation.fromDate);    

                if (currentDate.getTime() <= toDate.getTime() 
                && currentDate.getTime() >= fromDate.getTime())
                {       
                        var options = {
                            title: 'Advarsel',
                            message: 'Dette verktøyet er reservert av ' + reservation.userName + '. Er du sikker på at du vil sjekke ut verktøyet?'
                        }

                        ConfirmDialog(options, function(){
                            axios.put('/api/Tools/' + id, {
                                id: id,
                                name: '@Model.Name',
                                status: '@Model.Status',
                                checkedOut: true
                            })

                            self.checkedOut = true;
                    })
                    
                    stopLoop = true;
                }

                if (reservation == self.reservations[self.reservations.length - 1]
                && !stopLoop)
                {
                    axios.put('/api/Tools/' + id, {
                    id: id,
                    name: '@Model.Name',
                    status: '@Model.Status',
                    checkedOut: true
                })

                self.checkedOut = true;
                }
            })
            }
        },
        checkIn: function(id) {
            var self = this;

            axios.put('/api/Tools/' + id, {
            id: id,
            name: '@Model.Name',
            status: '@Model.Status',
            checkedOut: false
            })

            self.checkedOut = false;
        }
    }
})
</script>
}